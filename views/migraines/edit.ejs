<%- contentFor('body') %>

<section class="relative overflow-hidden py-8 sm:py-12 lg:py-16">
    <!-- Background decorative elements -->
    <div class="absolute inset-0 pointer-events-none" aria-hidden="true">
        <div class="absolute top-20 left-1/4 w-96 h-96 bg-sky-500/5 rounded-full blur-3xl"></div>
        <div class="absolute bottom-20 right-1/4 w-80 h-80 bg-indigo-500/5 rounded-full blur-3xl"></div>
    </div>

    <div class="container mx-auto px-6 relative">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8 sm:mb-10">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold leading-tight tracking-tight mb-4">
                    Edit Episode
                </h1>
                <p class="text-lg sm:text-xl text-slate-300 leading-relaxed">
                    Update your migraine episode details
                </p>
            </div>

            <!-- Form Container -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-6 sm:p-8 lg:p-10">
                <form class="space-y-6" action="/migraines/<%= migraineEvent._id %>?_method=PUT" method="POST">
                    <!-- Removes add details button from list view -->
                    <input type="hidden" name="quickLog" value="false">

                    <!-- Attack Type -->
                    <div>
                        <label for="attack-type" class="block text-sm font-medium text-slate-200 mb-3">Attack Type</label>
                        <fieldset id="attack-type" class="grid grid-cols-3 gap-2 rounded-xl bg-slate-800/50 border border-slate-700 p-1.5">
                            <div>
                                <input type="radio" id="migraineAT" value="migraine" name="attackType" class="peer hidden" required <%= migraineEvent.attackType === 'migraine' ? 'checked' : '' %>/>
                                <label for="migraineAT" class="block cursor-pointer select-none rounded-lg p-3 text-center font-semibold text-slate-300 hover:bg-red-900/40 peer-checked:bg-red-800/90 peer-checked:hover:bg-red-800 peer-checked:text-white transition-all duration-200">
                                    Migraine
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="headacheAT" value="headache" name="attackType" class="peer hidden" <%= migraineEvent.attackType === 'headache' ? 'checked' : '' %>/>
                                <label for="headacheAT" class="block cursor-pointer select-none rounded-lg p-3 text-center font-semibold text-slate-300 hover:bg-orange-900/40 peer-checked:bg-orange-800/90 peer-checked:hover:bg-orange-800 peer-checked:text-white transition-all duration-200">
                                    Headache
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="miscSymptomsAT" value="misc symptoms" name="attackType" class="peer hidden" <%= migraineEvent.attackType === 'misc symptoms' ? 'checked' : '' %> />
                                <label for="miscSymptomsAT" class="block cursor-pointer select-none rounded-lg p-3 text-center font-semibold text-slate-300 hover:bg-yellow-900/40 peer-checked:bg-yellow-800/90 peer-checked:hover:bg-yellow-800 peer-checked:text-white transition-all duration-200">
                                    Symptoms
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Date -->
                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-200 mb-2">Date</label>
                        <input 
                            type="date" 
                            id="date" 
                            name="date" 
                            value="<%= migraineEvent.date.toISOString().split('T')[0] %>" 
                            required 
                            class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 
                              rounded-lg text-slate-100 placeholder-slate-400
                              focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                              transition-all duration-300
                              hover:border-slate-600"
                        />
                    </div>

                    <!-- Duration (hidden) -->
                    <div hidden>
                        <label for="duration" class="block text-sm font-medium text-slate-200 mb-2">Duration (minutes)</label>
                        <input 
                            type="number" 
                            id="duration" 
                            name="duration" 
                            min="0" 
                            value="<%= migraineEvent.duration %>"
                            class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 
                              rounded-lg text-slate-100 placeholder-slate-400
                              focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                              transition-all duration-300
                              hover:border-slate-600"
                        />
                    </div>

                    <!-- Pain Level -->
                    <div>
                        <label for="pain-level" class="block text-sm font-medium text-slate-200 mb-3">Pain Level</label>
                        <fieldset id="pain-level" class="grid grid-cols-6 gap-2 rounded-xl bg-slate-800/50 border border-slate-700 p-2">
                            <div>
                                <input type="radio" id="0" value="0" name="painLevel" class="peer hidden" <%= migraineEvent.painLevel == 0 ? 'checked' : '' %>/>
                                <label for="0" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-green-600/30 peer-checked:bg-green-600 peer-checked:text-white transition-all duration-200">
                                    0
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="1" value="1" name="painLevel" class="peer hidden" <%= migraineEvent.painLevel == 1 ? 'checked' : '' %>/>
                                <label for="1" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-yellow-400/30 peer-checked:bg-yellow-400/90 peer-checked:text-slate-900 transition-all duration-200">
                                    1
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="2" value="2" name="painLevel" class="peer hidden" <%= migraineEvent.painLevel == 2 ? 'checked' : '' %> />
                                <label for="2" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-yellow-500/30 peer-checked:bg-yellow-500 peer-checked:text-white transition-all duration-200">
                                    2
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="3" value="3" name="painLevel" class="peer hidden" <%= migraineEvent.painLevel == 3 ? 'checked' : '' %> />
                                <label for="3" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-orange-400/30 peer-checked:bg-orange-400 peer-checked:text-white transition-all duration-200">
                                    3
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="4" value="4" name="painLevel" class="peer hidden" <%= migraineEvent.painLevel == 4 ? 'checked' : '' %> />
                                <label for="4" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-orange-600/30 peer-checked:bg-orange-600 peer-checked:text-white transition-all duration-200">
                                    4
                                </label>
                            </div>
                            <div>
                                <input type="radio" id="5" value="5" name="painLevel" class="peer hidden" <%= migraineEvent.painLevel == 5 ? 'checked' : '' %> />
                                <label for="5" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-red-800/30 peer-checked:bg-red-800 peer-checked:text-white transition-all duration-200">
                                    5
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Start Location -->
                    <div>
                        <label for="start-location" class="block text-sm font-medium text-slate-200 mb-3">Where did it start?</label>
                        <fieldset id="start-location" class="flex flex-wrap gap-2 rounded-xl bg-slate-800/50 border border-slate-700 p-2">
                            <div class="flex-1 min-w-[calc(33.33%-0.5rem)] sm:min-w-[calc(33.33%-0.5rem)]">
                                <input type="radio" id="home" value="home" name="startLocation" class="peer hidden" <%= migraineEvent.startLocation == 'home' ? 'checked' : '' %>/>
                                <label for="home" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-indigo-600/30 peer-checked:bg-indigo-600 peer-checked:text-white transition-all duration-200">
                                    home
                                </label>
                            </div>
                            <div class="flex-1 min-w-[calc(33.33%-0.5rem)] sm:min-w-[calc(33.33%-0.5rem)]">
                                <input type="radio" id="bed" value="bed" name="startLocation" class="peer hidden" <%= migraineEvent.startLocation == 'bed' ? 'checked' : '' %>/>
                                <label for="bed" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-indigo-600/30 peer-checked:bg-indigo-600 peer-checked:text-white transition-all duration-200">
                                    bed
                                </label>
                            </div>
                            <div class="flex-1 min-w-[calc(33.33%-0.5rem)] sm:min-w-[calc(33.33%-0.5rem)]">
                                <input type="radio" id="work" value="work" name="startLocation" class="peer hidden" <%= migraineEvent.startLocation == 'work' ? 'checked' : '' %>/>
                                <label for="work" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-indigo-600/30 peer-checked:bg-indigo-600 peer-checked:text-white transition-all duration-200">
                                    work
                                </label>
                            </div>
                            <div class="flex-1 min-w-[calc(33.33%-0.5rem)] sm:min-w-[calc(33.33%-0.5rem)]">
                                <input type="radio" id="school" value="school" name="startLocation" class="peer hidden" <%= migraineEvent.startLocation == 'school' ? 'checked' : '' %>/>
                                <label for="school" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-indigo-600/30 peer-checked:bg-indigo-600 peer-checked:text-white transition-all duration-200">
                                    school
                                </label>
                            </div>
                            <div class="flex-1 min-w-[calc(33.33%-0.5rem)] sm:min-w-[calc(33.33%-0.5rem)]">
                                <input type="radio" id="transit" value="transit" name="startLocation" class="peer hidden" <%= migraineEvent.startLocation == 'transit' ? 'checked' : '' %>/>
                                <label for="transit" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-indigo-600/30 peer-checked:bg-indigo-600 peer-checked:text-white transition-all duration-200">
                                    transit
                                </label>
                            </div>
                            <div class="flex-1 min-w-[calc(33.33%-0.5rem)] sm:min-w-[calc(33.33%-0.5rem)]">
                                <input type="radio" id="out" value="out" name="startLocation" class="peer hidden" <%= migraineEvent.startLocation == 'out' ? 'checked' : '' %>/>
                                <label for="out" class="block cursor-pointer select-none rounded-lg p-2 sm:p-3 text-center font-semibold text-slate-300 hover:bg-indigo-600/30 peer-checked:bg-indigo-600 peer-checked:text-white transition-all duration-200">
                                    out
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Pain Location -->
                    <div>
                        <label class="block text-sm font-medium text-slate-200 mb-3">Pain Location</label>
                        <ul class="grid grid-cols-2 sm:grid-cols-3 gap-2 rounded-xl bg-slate-800/50 border border-slate-700 p-2">
                            <% ['left', 'front', 'right', 'other', 'back', 'entire head'].forEach(function(location) { %>
                                <li class="inline-flex">
                                    <div class="relative flex items-center w-full p-2 rounded-lg hover:bg-slate-700/50 transition-colors">
                                        <div class="flex items-center h-5">
                                            <input 
                                                id="<%= location %>" 
                                                name="painLocation" 
                                                type="checkbox" 
                                                value="<%= location %>"
                                                class="w-5 h-5 text-indigo-600 cursor-pointer border-slate-600 rounded-md bg-slate-700 focus:ring-2 focus:ring-sky-500/20 focus:ring-offset-0 focus:border-sky-500"
                                                <%= migraineEvent.painLocation.includes(location) ? 'checked' : '' %>
                                            />
                                        </div>
                                        <label for="<%= location %>" class="ml-2 block text-sm font-medium text-slate-300 cursor-pointer">
                                            <%= location.charAt(0).toUpperCase() + location.slice(1) %>
                                        </label>
                                    </div>
                                </li>
                            <% }); %>
                        </ul>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-slate-200 mb-2">Notes</label>
                        <textarea 
                            id="notes" 
                            name="notes" 
                            rows="3" 
                            class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 
                              rounded-lg text-slate-100 placeholder-slate-400
                              focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                              transition-all duration-300
                              hover:border-slate-600
                              resize-y"
                            placeholder="Add any additional notes..."
                        ><%= migraineEvent.notes %></textarea>
                    </div>

                    <!-- Medication -->
                    <div class="flex items-center p-3 rounded-lg bg-slate-800/30 border border-slate-700/50">
                        <input 
                            type="checkbox" 
                            id="medication" 
                            name="medication" 
                            class="h-5 w-5 rounded border-slate-600 bg-slate-700 text-indigo-600 focus:ring-2 focus:ring-sky-500/20 focus:ring-offset-0 focus:border-sky-500 cursor-pointer"
                            <%= migraineEvent.medication ? 'checked' : '' %>
                        />
                        <label for="medication" class="ml-3 block text-sm font-medium text-slate-200 cursor-pointer">
                            Medication Taken
                        </label>
                    </div>
                    
                    <!-- Medication Details -->
                    <div id="medicationDetails" class="space-y-4 <%= migraineEvent.medication ? '' : 'hidden' %> p-4 rounded-lg bg-slate-800/30 border border-slate-700/50">
                        <h3 class="text-lg font-semibold text-slate-200">Medication Details</h3>
                        <div id="medicationList"></div>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input 
                                type="text" 
                                id="medName" 
                                placeholder="Name" 
                                class="flex-1 min-w-0 px-4 py-3 bg-slate-800/50 border border-slate-700 
                                  rounded-lg text-slate-100 placeholder-slate-400
                                  focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                                  transition-all duration-300
                                  hover:border-slate-600"
                            />
                            <input 
                                type="text" 
                                id="medDose" 
                                placeholder="Dose" 
                                class="flex-1 min-w-0 px-4 py-3 bg-slate-800/50 border border-slate-700 
                                  rounded-lg text-slate-100 placeholder-slate-400
                                  focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                                  transition-all duration-300
                                  hover:border-slate-600"
                            />
                            <input 
                                type="number" 
                                id="medQuantity" 
                                placeholder="Quantity" 
                                min="0" 
                                class="flex-1 min-w-0 px-4 py-3 bg-slate-800/50 border border-slate-700 
                                  rounded-lg text-slate-100 placeholder-slate-400
                                  focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                                  transition-all duration-300
                                  hover:border-slate-600"
                            />
                            <button 
                                type="button" 
                                id="addMedication" 
                                class="flex-shrink-0 px-4 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-lg transition-all duration-300 hover:scale-[1.02] active:scale-[0.98] whitespace-nowrap"
                            >
                                Add
                            </button>
                        </div>
                        <div id="medicationSuggestions" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg shadow-lg hidden"></div>
                    </div>

                    <!-- Triggers -->
                    <div>
                        <label for="triggers" class="block text-sm font-medium text-slate-200 mb-2">Triggers</label>
                        <div class="mt-2 flex flex-wrap gap-2 mb-2" id="selectedTriggers">
                            <% if (migraineEvent.triggers && migraineEvent.triggers.length > 0) { %>
                                <% migraineEvent.triggers.forEach(function(trigger) { %>
                                    <% if (trigger.trim() !== "") { %>
                                        <span class="bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 text-sm font-medium px-3 py-1.5 rounded-lg flex items-center">
                                            <%= trigger %>
                                            <button type="button" class="ml-2 text-indigo-300 hover:text-indigo-100 transition-colors" onclick="removeTrigger('<%= trigger %>')">Ã—</button>
                                        </span>
                                    <% } %>
                                <% }); %>
                            <% } %>
                        </div>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="triggerInput" 
                                class="w-full px-4 py-3 pr-20 bg-slate-800/50 border border-slate-700 
                                  rounded-lg text-slate-100 placeholder-slate-400
                                  focus:border-sky-500 focus:ring-2 focus:ring-sky-500/20
                                  transition-all duration-300
                                  hover:border-slate-600" 
                                placeholder="Enter a trigger"
                            />
                            <button 
                                type="button" 
                                id="addTrigger" 
                                class="absolute inset-y-0 right-0 flex items-center px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-r-lg transition-colors focus:outline-none focus:ring-2 focus:ring-sky-500/20"
                            >
                                Add
                            </button>
                        </div>
                        <div id="triggerSuggestions" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg shadow-lg hidden"></div>
                        <input type="hidden" id="triggers" name="triggers" value="<%= migraineEvent.triggers.join(',') %>">
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-2">
                        <button 
                            type="submit" 
                            class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-lg transition-all duration-300 hover:scale-[1.02] active:scale-[0.98] shadow-lg shadow-indigo-500/20"
                        >
                            Update Migraine Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
// Pass in existing triggers, filtering out empty strings
window.existingTriggers = JSON.parse('<%- JSON.stringify(migraineEvent.triggers.filter(trigger => trigger.trim() !== "")) %>');

// Pass in existing medication
window.existingMedications = JSON.parse('<%- JSON.stringify(migraineEvent.medications || []) %>');
</script>

<script src="/js/medDetailsToggle.js" type="text/javascript"></script>
<script src="/js/medication.js" type="text/javascript"></script>
<script src="/js/triggers.js" type="text/javascript"></script>
<script src="/js/dateHandler.js" type="text/javascript"></script>

<script>
    restrictFutureDates();
</script>
